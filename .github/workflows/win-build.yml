name: Windows CI (V1 RC)

on:
  push:
    branches: [ release/windows-v1-rc1 ]
  workflow_dispatch: {}

concurrency:
  group: windows-rc
  cancel-in-progress: true

jobs:
  build-windows:
    runs-on: windows-2022
    env:
      VCPKG_DEFAULT_TRIPLET: x64-windows
      VCPKG_TARGET_TRIPLET: x64-windows
      CMAKE_BUILD_TYPE: Release
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC dev cmd
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}\vcpkg\installed
            ${{ github.workspace }}\vcpkg\downloads
          key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: vcpkg-${{ runner.os }}-

      - name: Bootstrap embedded vcpkg
        run: .\vcpkg\bootstrap-vcpkg.bat -disableMetrics

      - name: Install deps (manifest or explicit)
        shell: pwsh
        run: |
          if (Test-Path "vcpkg.json") {
            .\vcpkg\vcpkg.exe install --triplet $env:VCPKG_TARGET_TRIPLET
          } else {
            .\vcpkg\vcpkg.exe install `
              tbb:$env:VCPKG_TARGET_TRIPLET nlopt:$env:VCPKG_TARGET_TRIPLET `
              openvdb:$env:VCPKG_TARGET_TRIPLET imath:$env:VCPKG_TARGET_TRIPLET `
              openexr:$env:VCPKG_TARGET_TRIPLET blosc:$env:VCPKG_TARGET_TRIPLET `
              glew:$env:VCPKG_TARGET_TRIPLET eigen3:$env:VCPKG_TARGET_TRIPLET `
              libpng:$env:VCPKG_TARGET_TRIPLET zlib:$env:VCPKG_TARGET_TRIPLET `
              bzip2:$env:VCPKG_TARGET_TRIPLET curl:$env:VCPKG_TARGET_TRIPLET `
              freetype:$env:VCPKG_TARGET_TRIPLET harfbuzz:$env:VCPKG_TARGET_TRIPLET `
              libjpeg-turbo:$env:VCPKG_TARGET_TRIPLET tiff:$env:VCPKG_TARGET_TRIPLET `
              libzip:$env:VCPKG_TARGET_TRIPLET expat:$env:VCPKG_TARGET_TRIPLET `
              libdeflate:$env:VCPKG_TARGET_TRIPLET openjph:$env:VCPKG_TARGET_TRIPLET
          }

      - name: Ensure VERSION file
        shell: pwsh
        run: |
          if (-not (Test-Path VERSION)) { '1.0.0+100' | Out-File -Encoding ascii VERSION }

      - name: Configure (Ninja)
        run: >
          cmake -S . -B build\win64 -G Ninja
          -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }}
          -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}\vcpkg\scripts\buildsystems\vcpkg.cmake"
          -DVCPKG_TARGET_TRIPLET=${{ env.VCPKG_TARGET_TRIPLET }}
          -DVCPKG_APPLOCAL_DEPS=ON
          -DCMAKE_FIND_PACKAGE_PREFER_CONFIG=ON
          -DSLIC3R_STATIC=OFF -DSLIC3R_BUILD_TESTS=OFF
          -DLIBRESLICER_BRAND=ON
          -DOpenEXR_DIR="${{ github.workspace }}\vcpkg\installed\x64-windows\share\openexr"
          -DImath_DIR="${{ github.workspace }}\vcpkg\installed\x64-windows\share\imath"
          -DOPENVDB_ROOT="${{ github.workspace }}\vcpkg\installed\x64-windows"
          -Dglew_DIR="${{ github.workspace }}\vcpkg\installed\x64-windows\share\glew"
          -DGP_TOOL=dumpbin
          -DCMAKE_OBJDUMP:FILEPATH=""

      - name: Build
        run: cmake --build build\win64 -j 2

      - name: Create portable ZIP
        shell: pwsh
        run: |
          $ErrorActionPreference='Stop'
          $root = "${{ github.workspace }}"
          $out  = Join-Path $root 'dist'
          New-Item -ItemType Directory -Force -Path $out | Out-Null
          $ver = Get-Content (Join-Path $root 'VERSION') | Select-Object -First 1
          $stage = Join-Path $out 'AegisSlicer_Portable'
          Remove-Item $stage -Recurse -Force -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force -Path $stage | Out-Null
          Copy-Item 'build\win64\AegisSlicer.exe' $stage
          Copy-Item 'LICENSE','SOURCE_OFFER.md','THIRD_PARTY_NOTICES.txt','CREDITS.md' -Destination $stage -ErrorAction SilentlyContinue
          if (Test-Path 'resources') { Copy-Item 'resources' -Destination (Join-Path $stage 'resources') -Recurse }
          if (Test-Path 'profiles')  { Copy-Item 'profiles'  -Destination (Join-Path $stage 'profiles')  -Recurse }
          if (Test-Path 'docs\FAQ.md'){ Copy-Item 'docs\FAQ.md' $stage }
          if (Test-Path 'scripts\post_slice_to_uvtools.bat'){ Copy-Item 'scripts\post_slice_to_uvtools.bat' $stage }
          Push-Location $out
          $zip = "AegisSlicer_Portable_v$ver.zip"
          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path 'AegisSlicer_Portable\*' -DestinationPath $zip
          Pop-Location

      - name: Build Inno installer
        run: cmake --build build\win64 --target installer

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-v1-rc1-artifacts
          path: |
            dist\AegisSlicer_Portable_v*.zip
            build\win64\*.exe
          if-no-files-found: warn
