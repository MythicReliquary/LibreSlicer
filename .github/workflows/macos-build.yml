name: macOS CI (V1 RC)

on:
  push:
    branches:
      - release/windows-v1-rc1
  workflow_dispatch: {}

concurrency:
  group: macos-rc
  cancel-in-progress: true

jobs:
  build-macos:
    runs-on: macos-latest
    env:
      VCPKG_DEFAULT_TRIPLET: x64-osx
      VCPKG_TARGET_TRIPLET: x64-osx
      CMAKE_BUILD_TYPE: Release
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: brew install ninja cmake

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/vcpkg/installed
            ${{ github.workspace }}/vcpkg/downloads
          key: vcpkg-macos-${{ hashFiles('vcpkg.json') }}
          restore-keys: vcpkg-macos-

      - name: Bootstrap embedded vcpkg
        run: ./vcpkg/bootstrap-vcpkg.sh -disableMetrics

      - name: Install deps (manifest)
        run: ./vcpkg/vcpkg install --triplet $VCPKG_TARGET_TRIPLET

      - name: Ensure VERSION file
        run: |
          [ -f VERSION ] || echo '1.0.0+100' > VERSION

      - name: Configure (Ninja)
        run: >
          cmake -S . -B build/macos -G Ninja
          -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }}
          -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake"
          -DVCPKG_TARGET_TRIPLET=${{ env.VCPKG_TARGET_TRIPLET }}
          -DVCPKG_APPLOCAL_DEPS=ON
          -DCMAKE_FIND_PACKAGE_PREFER_CONFIG=ON
          -DSLIC3R_STATIC=OFF -DSLIC3R_BUILD_TESTS=OFF
          -DLIBRESLICER_BRAND=ON

      - name: Build
        run: cmake --build build/macos -j 2

      - name: Create .dmg
        run: |
          mkdir -p dist
          ver=$(head -n 1 VERSION)
          appdir=dist/LibreSlicer.app
          mkdir -p "$appdir/Contents/MacOS"
          if [ -f build/macos/LibreSlicer ]; then
            cp build/macos/LibreSlicer "$appdir/Contents/MacOS/"
          fi
          cp LICENSE THIRD_PARTY_NOTICES.txt CREDITS.md "$appdir/Contents/MacOS/" 2>/dev/null || true
          if [ -f COMPLIANCE/SOURCE_OFFER.md ]; then
            cp COMPLIANCE/SOURCE_OFFER.md "$appdir/Contents/MacOS/"
          fi
          hdiutil create -volname "LibreSlicer $ver" -srcfolder "$appdir" -ov -format UDZO "dist/LibreSlicer_v${ver}.dmg"

      - name: Codesign and Notarize (optional)
        if: ${{ secrets.APPLE_ID && secrets.APP_SPECIFIC_PASSWORD }}
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APP_SPECIFIC_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
        run: |
          set -e
          if [ -d dist/LibreSlicer.app ]; then
            codesign --deep --force --options runtime --sign "Developer ID Application: Mythic Reliquary LLC" dist/LibreSlicer.app || true
          fi
          dmg=$(ls dist/LibreSlicer_v*.dmg | head -n 1)
          if [ -n "$dmg" ]; then
            xcrun notarytool submit "$dmg" --apple-id "$APPLE_ID" --password "$APP_SPECIFIC_PASSWORD" --wait
            xcrun stapler staple "$dmg" || true
          else
            echo "No DMG found for notarization."
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-v1-rc1-artifacts
          path: |
            dist/LibreSlicer_v*.dmg
          if-no-files-found: warn
